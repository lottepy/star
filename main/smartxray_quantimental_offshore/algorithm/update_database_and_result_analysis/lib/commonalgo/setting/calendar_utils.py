from datetime import datetime, timedelta, date

OFFICIAL_HOLIDAYS = {
    'US': [
        '2000-01-17', '2000-02-21', '2000-04-21', '2000-05-29', '2000-07-04', '2000-09-04', '2000-10-09', '2000-11-23',
        '2000-12-25', '2001-01-01', '2001-01-15', '2001-02-19', '2001-04-13', '2001-05-28', '2001-07-04', '2001-09-03',
        '2001-10-08', '2001-11-12', '2001-11-22', '2001-12-25', '2002-01-01', '2002-01-21', '2002-02-18', '2002-03-29',
        '2002-05-27', '2002-07-04', '2002-09-02', '2002-10-14', '2002-11-11', '2002-11-28', '2002-12-25', '2003-01-01',
        '2003-01-20', '2003-02-17', '2003-04-18', '2003-05-26', '2003-07-04', '2003-09-01', '2003-10-13', '2003-11-11',
        '2003-11-27', '2003-12-25', '2004-01-01', '2004-01-19', '2004-02-16', '2004-04-09', '2004-05-31', '2004-07-05',
        '2004-09-06', '2004-10-11', '2004-11-11', '2004-11-25', '2004-12-24', '2005-01-17', '2005-02-21', '2005-03-25',
        '2005-05-30', '2005-07-04', '2005-09-05', '2005-10-10', '2005-11-11', '2005-11-24', '2005-12-26', '2006-01-02',
        '2006-01-16', '2006-02-20', '2006-04-14', '2006-05-29', '2006-07-04', '2006-09-04', '2006-10-09', '2006-11-23',
        '2006-12-25', '2007-01-01', '2007-01-15', '2007-02-19', '2007-04-06', '2007-05-28', '2007-07-04', '2007-09-03',
        '2007-10-08', '2007-11-12', '2007-11-22', '2007-12-25', '2008-01-01', '2008-01-21', '2008-02-18', '2008-03-21',
        '2008-05-26', '2008-07-04', '2008-09-01', '2008-10-13', '2008-11-11', '2008-11-27', '2008-12-25', '2009-01-01',
        '2009-01-19', '2009-02-16', '2009-04-10', '2009-05-25', '2009-07-03', '2009-09-07', '2009-10-12', '2009-11-11',
        '2009-11-26', '2009-12-25', '2010-01-01', '2010-01-18', '2010-02-15', '2010-04-02', '2010-05-31', '2010-07-05',
        '2010-09-06', '2010-10-11', '2010-11-11', '2010-11-25', '2010-12-24', '2011-01-17', '2011-02-21', '2011-04-22',
        '2011-05-30', '2011-07-04', '2011-09-05', '2011-10-10', '2011-11-11', '2011-11-24', '2011-12-26', '2012-01-02',
        '2012-01-16', '2012-02-20', '2012-04-06', '2012-05-28', '2012-07-04', '2012-09-03', '2012-10-08', '2012-11-12',
        '2012-11-22', '2012-12-25', '2013-01-01', '2013-01-21', '2013-02-18', '2013-03-29', '2013-05-27', '2013-07-04',
        '2013-09-02', '2013-10-14', '2013-11-11', '2013-11-28', '2013-12-25', '2014-01-01', '2014-01-20', '2014-02-17',
        '2014-04-18', '2014-05-26', '2014-07-04', '2014-09-01', '2014-10-13', '2014-11-11', '2014-11-27', '2014-12-25',
        '2015-01-01', '2015-01-19', '2015-02-16', '2015-04-03', '2015-05-25', '2015-07-03', '2015-09-07', '2015-10-12',
        '2015-11-11', '2015-11-26', '2015-12-25', '2016-01-01', '2016-01-18', '2016-02-15', '2016-03-25', '2016-05-30',
        '2016-07-04', '2016-09-05', '2016-10-10', '2016-11-11', '2016-11-24', '2016-12-26', '2017-01-02', '2017-01-16',
        '2017-02-20', '2017-04-14', '2017-05-29', '2017-07-04', '2017-09-04', '2017-10-09', '2017-11-23', '2017-12-25',
        '2018-01-01', '2018-01-15', '2018-02-19', '2018-03-30', '2018-05-28', '2018-07-04', '2018-09-03', '2018-10-08',
        '2018-11-12', '2018-11-22', '2018-12-25', '2019-01-01', '2019-01-21', '2019-02-18', '2019-04-19', '2019-05-27',
        '2019-07-04', '2019-09-02', '2019-10-14', '2019-11-11', '2019-11-28', '2019-12-25'
    ],
    'HK': [
        '2000-02-04', '2000-02-07', '2000-04-04', '2000-04-21', '2000-04-24', '2000-05-01', '2000-05-11', '2000-06-06',
        '2000-09-13', '2000-10-02', '2000-10-06', '2000-12-25', '2000-12-26', '2001-01-01', '2001-01-24', '2001-01-25',
        '2001-01-26', '2001-04-05', '2001-04-13', '2001-04-16', '2001-04-30', '2001-05-01', '2001-06-25', '2001-07-02',
        '2001-10-01', '2001-10-02', '2001-10-25', '2001-12-25', '2001-12-26', '2002-01-01', '2002-02-12', '2002-02-13',
        '2002-02-14', '2002-03-29', '2002-04-01', '2002-04-05', '2002-05-01', '2002-05-20', '2002-07-01', '2002-10-01',
        '2002-10-14', '2002-12-25', '2002-12-26', '2003-01-01', '2003-01-31', '2003-02-03', '2003-04-18', '2003-04-21',
        '2003-05-01', '2003-05-08', '2003-06-04', '2003-07-01', '2003-09-12', '2003-10-01', '2003-12-25', '2003-12-26',
        '2004-01-01', '2004-01-22', '2004-01-23', '2004-04-05', '2004-04-09', '2004-04-12', '2004-05-26', '2004-06-22',
        '2004-07-01', '2004-09-29', '2004-10-01', '2004-10-22', '2004-12-27', '2005-02-09', '2005-02-10', '2005-02-11',
        '2005-03-25', '2005-03-28', '2005-04-05', '2005-05-02', '2005-05-16', '2005-07-01', '2005-09-19', '2005-10-11',
        '2005-12-26', '2005-12-27', '2006-01-02', '2006-01-30', '2006-01-31', '2006-04-05', '2006-04-14', '2006-04-17',
        '2006-05-01', '2006-05-05', '2006-05-31', '2006-10-02', '2006-10-30', '2006-12-25', '2006-12-26', '2007-01-01',
        '2007-02-19', '2007-02-20', '2007-04-05', '2007-04-06', '2007-04-09', '2007-05-01', '2007-05-24', '2007-06-19',
        '2007-07-02', '2007-09-26', '2007-10-01', '2007-10-19', '2007-12-25', '2007-12-26', '2008-01-01', '2008-02-07',
        '2008-02-08', '2008-03-21', '2008-03-24', '2008-04-04', '2008-05-01', '2008-05-12', '2008-06-09', '2008-07-01',
        '2008-09-15', '2008-10-01', '2008-10-07', '2008-12-25', '2008-12-26', '2009-01-01', '2009-01-26', '2009-01-27',
        '2009-01-28', '2009-04-10', '2009-04-13', '2009-05-01', '2009-05-28', '2009-07-01', '2009-10-01', '2009-10-26',
        '2009-12-25', '2010-01-01', '2010-02-15', '2010-02-16', '2010-04-02', '2010-04-05', '2010-04-06', '2010-05-21',
        '2010-06-16', '2010-07-01', '2010-09-23', '2010-10-01', '2010-12-27', '2011-02-03', '2011-02-04', '2011-04-05',
        '2011-04-22', '2011-04-25', '2011-05-02', '2011-05-10', '2011-06-06', '2011-07-01', '2011-09-13', '2011-10-05',
        '2011-12-26', '2011-12-27', '2012-01-02', '2012-01-23', '2012-01-24', '2012-01-25', '2012-04-04', '2012-04-06',
        '2012-04-09', '2012-05-01', '2012-07-02', '2012-10-01', '2012-10-02', '2012-10-23', '2012-12-25', '2012-12-26',
        '2013-01-01', '2013-02-11', '2013-02-12', '2013-02-13', '2013-03-29', '2013-04-01', '2013-04-04', '2013-05-01',
        '2013-05-17', '2013-06-12', '2013-07-01', '2013-09-20', '2013-10-01', '2013-10-14', '2013-12-25', '2013-12-26',
        '2014-01-01', '2014-01-31', '2014-02-03', '2014-04-18', '2014-04-21', '2014-05-01', '2014-05-06', '2014-06-02',
        '2014-07-01', '2014-09-09', '2014-10-01', '2014-10-02', '2014-12-25', '2014-12-26', '2015-01-01', '2015-02-19',
        '2015-02-20', '2015-04-03', '2015-04-06', '2015-04-07', '2015-05-01', '2015-05-25', '2015-07-01', '2015-09-03',
        '2015-09-28', '2015-10-01', '2015-10-21', '2015-12-25', '2016-01-01', '2016-02-08', '2016-02-09', '2016-02-10',
        '2016-03-25', '2016-03-28', '2016-04-04', '2016-05-02', '2016-06-09', '2016-07-01', '2016-08-02', '2016-09-16',
        '2016-10-10', '2016-10-21', '2016-12-26', '2016-12-27', '2017-01-02', '2017-01-30', '2017-01-31', '2017-04-04',
        '2017-04-14', '2017-04-17', '2017-05-01', '2017-05-03', '2017-05-30', '2017-10-02', '2017-10-05', '2017-12-25',
        '2017-12-26', '2018-01-01', '2018-02-16', '2018-02-19', '2018-03-30', '2018-04-02', '2018-04-05', '2018-05-01',
        '2018-05-22', '2018-06-18', '2018-07-02', '2018-09-25', '2018-10-01', '2018-10-17', '2018-12-25', '2018-12-26',
        '2019-01-01', '2019-02-05', '2019-02-06', '2019-02-07', '2019-04-05', '2019-04-19', '2019-04-22', '2019-05-01',
        '2019-05-13', '2019-06-07', '2019-07-01', '2019-10-01', '2019-10-07', '2019-12-25', '2019-12-26'
    ],
    'CN': [
        '2000-01-03', '2000-01-31', '2000-02-01', '2000-02-02', '2000-02-03', '2000-02-04', '2000-02-07', '2000-02-08',
        '2000-02-09', '2000-02-10', '2000-02-11', '2000-05-01', '2000-05-02', '2000-05-03', '2000-05-04', '2000-05-05',
        '2000-10-02', '2000-10-03', '2000-10-04', '2000-10-05', '2000-10-06', '2001-01-01', '2001-01-22', '2001-01-23',
        '2001-01-24', '2001-01-25', '2001-01-26', '2001-01-29', '2001-01-30', '2001-01-31', '2001-02-01', '2001-02-02',
        '2001-05-01', '2001-05-02', '2001-05-03', '2001-05-04', '2001-05-07', '2001-10-01', '2001-10-02', '2001-10-03',
        '2001-10-04', '2001-10-05', '2002-01-01', '2002-01-02', '2002-01-03', '2002-02-11', '2002-02-12', '2002-02-13',
        '2002-02-14', '2002-02-15', '2002-02-18', '2002-02-19', '2002-02-20', '2002-02-21', '2002-02-22', '2002-05-01',
        '2002-05-02', '2002-05-03', '2002-05-06', '2002-05-07', '2002-09-30', '2002-10-01', '2002-10-02', '2002-10-03',
        '2002-10-04', '2002-10-07', '2003-01-01', '2003-01-30', '2003-01-31', '2003-02-03', '2003-02-04', '2003-02-05',
        '2003-02-06', '2003-02-07', '2003-05-01', '2003-05-02', '2003-05-05', '2003-05-06', '2003-05-07', '2003-05-08',
        '2003-05-09', '2003-10-01', '2003-10-02', '2003-10-03', '2003-10-06', '2003-10-07', '2004-01-01', '2004-01-19',
        '2004-01-20', '2004-01-21', '2004-01-22', '2004-01-23', '2004-01-26', '2004-01-27', '2004-01-28', '2004-05-03',
        '2004-05-04', '2004-05-05', '2004-05-06', '2004-05-07', '2004-10-01', '2004-10-04', '2004-10-05', '2004-10-06',
        '2004-10-07', '2005-01-03', '2005-02-07', '2005-02-08', '2005-02-09', '2005-02-10', '2005-02-11', '2005-02-14',
        '2005-02-15', '2005-05-02', '2005-05-03', '2005-05-04', '2005-05-05', '2005-05-06', '2005-10-03', '2005-10-04',
        '2005-10-05', '2005-10-06', '2005-10-07', '2006-01-02', '2006-01-03', '2006-01-26', '2006-01-27', '2006-01-30',
        '2006-01-31', '2006-02-01', '2006-02-02', '2006-02-03', '2006-05-01', '2006-05-02', '2006-05-03', '2006-05-04',
        '2006-05-05', '2006-10-02', '2006-10-03', '2006-10-04', '2006-10-05', '2006-10-06', '2007-01-01', '2007-01-02',
        '2007-01-03', '2007-02-19', '2007-02-20', '2007-02-21', '2007-02-22', '2007-02-23', '2007-05-01', '2007-05-02',
        '2007-05-03', '2007-05-04', '2007-05-07', '2007-10-01', '2007-10-02', '2007-10-03', '2007-10-04', '2007-10-05',
        '2007-12-31', '2008-01-01', '2008-02-06', '2008-02-07', '2008-02-08', '2008-02-11', '2008-02-12', '2008-04-04',
        '2008-05-01', '2008-05-02', '2008-06-09', '2008-09-15', '2008-09-29', '2008-09-30', '2008-10-01', '2008-10-02',
        '2008-10-03', '2009-01-01', '2009-01-02', '2009-01-26', '2009-01-27', '2009-01-28', '2009-01-29', '2009-01-30',
        '2009-04-06', '2009-05-01', '2009-05-28', '2009-05-29', '2009-10-01', '2009-10-02', '2009-10-05', '2009-10-06',
        '2009-10-07', '2009-10-08', '2010-01-01', '2010-02-15', '2010-02-16', '2010-02-17', '2010-02-18', '2010-02-19',
        '2010-04-05', '2010-05-03', '2010-06-14', '2010-06-15', '2010-06-16', '2010-09-22', '2010-09-23', '2010-09-24',
        '2010-10-01', '2010-10-04', '2010-10-05', '2010-10-06', '2010-10-07', '2011-01-03', '2011-02-02', '2011-02-03',
        '2011-02-04', '2011-02-07', '2011-02-08', '2011-04-04', '2011-04-05', '2011-05-02', '2011-06-06', '2011-09-12',
        '2011-10-03', '2011-10-04', '2011-10-05', '2011-10-06', '2011-10-07', '2012-01-02', '2012-01-03', '2012-01-23',
        '2012-01-24', '2012-01-25', '2012-01-26', '2012-01-27', '2012-04-02', '2012-04-03', '2012-04-04', '2012-04-30',
        '2012-05-01', '2012-06-22', '2012-10-01', '2012-10-02', '2012-10-03', '2012-10-04', '2012-10-05', '2013-01-01',
        '2013-01-02', '2013-01-03', '2013-02-11', '2013-02-12', '2013-02-13', '2013-02-14', '2013-02-15', '2013-04-04',
        '2013-04-05', '2013-04-29', '2013-04-30', '2013-05-01', '2013-06-10', '2013-06-11', '2013-06-12', '2013-09-19',
        '2013-09-20', '2013-10-01', '2013-10-02', '2013-10-03', '2013-10-04', '2013-10-07', '2014-01-01', '2014-01-31',
        '2014-02-03', '2014-02-04', '2014-02-05', '2014-02-06', '2014-04-07', '2014-05-01', '2014-05-02', '2014-06-02',
        '2014-09-08', '2014-10-01', '2014-10-02', '2014-10-03', '2014-10-06', '2014-10-07', '2015-01-01', '2015-01-02',
        '2015-02-18', '2015-02-19', '2015-02-20', '2015-02-23', '2015-02-24', '2015-04-06', '2015-05-01', '2015-06-22',
        '2015-09-03', '2015-09-04', '2015-10-01', '2015-10-02', '2015-10-05', '2015-10-06', '2015-10-07', '2016-01-01',
        '2016-02-08', '2016-02-09', '2016-02-10', '2016-02-11', '2016-02-12', '2016-04-04', '2016-05-02', '2016-06-09',
        '2016-06-10', '2016-09-15', '2016-09-16', '2016-10-03', '2016-10-04', '2016-10-05', '2016-10-06', '2016-10-07',
        '2017-01-02', '2017-01-27', '2017-01-30', '2017-01-31', '2017-02-01', '2017-02-02', '2017-04-03', '2017-04-04',
        '2017-05-01', '2017-05-29', '2017-05-30', '2017-10-02', '2017-10-03', '2017-10-04', '2017-10-05', '2017-10-06',
        '2018-01-01', '2018-02-15', '2018-02-16', '2018-02-19', '2018-02-20', '2018-02-21', '2018-04-05', '2018-04-06',
        '2018-04-30', '2018-05-01', '2018-06-18', '2018-09-24', '2018-10-01', '2018-10-02', '2018-10-03', '2018-10-04',
        '2018-10-05', '2018-12-31', '2019-01-01', '2019-02-04', '2019-02-05', '2019-02-06', '2019-02-07', '2019-02-08',
        '2019-04-05', '2019-05-01', '2019-06-07', '2019-09-13', '2019-10-01', '2019-10-02', '2019-10-03', '2019-10-04',
        '2019-10-07'
    ],
    "GB": [
        '2000-01-03', '2000-04-21', '2000-04-24', '2000-05-01', '2000-05-29', '2000-08-28', '2000-12-25', '2000-12-26',
        '2001-01-01', '2001-04-13', '2001-04-16', '2001-05-07', '2001-05-28', '2001-08-27', '2001-12-25', '2001-12-26',
        '2002-01-01', '2002-03-29', '2002-04-01', '2002-05-06', '2002-06-03', '2002-06-04', '2002-08-26', '2002-12-25',
        '2002-12-26', '2003-01-01', '2003-04-18', '2003-04-21', '2003-05-05', '2003-05-26', '2003-08-25', '2003-12-25',
        '2003-12-26', '2004-01-01', '2004-04-09', '2004-04-12', '2004-05-03', '2004-05-31', '2004-08-30', '2004-12-27',
        '2004-12-28', '2005-01-03', '2005-03-25', '2005-03-28', '2005-05-02', '2005-05-30', '2005-08-29', '2005-12-26',
        '2005-12-27', '2006-01-02', '2006-04-14', '2006-04-17', '2006-05-01', '2006-05-29', '2006-08-28', '2006-12-25',
        '2006-12-26', '2007-01-01', '2007-04-06', '2007-04-09', '2007-05-07', '2007-05-28', '2007-08-27', '2007-12-25',
        '2007-12-26', '2008-01-01', '2008-03-21', '2008-03-24', '2008-05-05', '2008-05-26', '2008-08-25', '2008-12-25',
        '2008-12-26', '2009-01-01', '2009-04-10', '2009-04-13', '2009-05-04', '2009-05-25', '2009-08-31', '2009-12-25',
        '2009-12-28', '2010-01-01', '2010-04-02', '2010-04-05', '2010-05-03', '2010-05-31', '2010-08-30', '2010-12-27',
        '2010-12-28', '2011-01-03', '2011-04-22', '2011-04-25', '2011-04-29', '2011-05-02', '2011-05-30', '2011-08-29',
        '2011-12-26', '2011-12-27', '2012-01-02', '2012-04-06', '2012-04-09', '2012-05-07', '2012-06-04', '2012-06-05',
        '2012-08-27', '2012-12-25', '2012-12-26', '2013-01-01', '2013-03-29', '2013-04-01', '2013-05-06', '2013-05-27',
        '2013-08-26', '2013-12-25', '2013-12-26', '2014-01-01', '2014-04-18', '2014-04-21', '2014-05-05', '2014-05-26',
        '2014-08-25', '2014-12-25', '2014-12-26', '2015-01-01', '2015-04-03', '2015-04-06', '2015-05-04', '2015-05-25',
        '2015-08-31', '2015-12-25', '2015-12-28', '2016-01-01', '2016-03-25', '2016-03-28', '2016-05-02', '2016-05-30',
        '2016-08-29', '2016-12-26', '2016-12-27', '2017-01-02', '2017-04-14', '2017-04-17', '2017-05-01', '2017-05-29',
        '2017-08-28', '2017-12-25', '2017-12-26', '2018-01-01', '2018-03-30', '2018-04-02', '2018-05-07', '2018-05-28',
        '2018-08-27', '2018-12-25', '2018-12-26', '2019-01-01', '2019-04-19', '2019-04-22', '2019-05-06', '2019-05-27',
        '2019-08-26', '2019-12-25', '2019-12-26'
    ],
    'DE': [
        '2018-01-01',
        '2018-03-30',
        '2018-04-02',
        '2018-05-01',
        '2018-05-21',
        '2018-10-03',
        '2018-12-25',
        '2018-12-26',
    ],
    'WW': []
}
OFFICIAL_HOLIDAYS['WW'] = OFFICIAL_HOLIDAYS['HK']

ADHOC_HOLIDAYS = {
    'US': ['2018-12-05'],
}


# Monday is 1, Sunday is 7. date.isoweekday()
class TradingCalendar(object):
    WEEKEND = [6, 7]
    DATE_FORMAT = '%Y-%m-%d'

    def __init__(self, *regions):
        self.holidays = set([])
        for region in regions:
            self.holidays |= set(OFFICIAL_HOLIDAYS[region]) | set(ADHOC_HOLIDAYS.get(region, []))

    def to_string(self, dt):
        return dt.strftime(self.DATE_FORMAT)

    def shift(self, dt, days):
        return dt + timedelta(days=days)

    def next_business_day(self, dt):
        next_dt = dt
        for i in range(10):
            next_dt += timedelta(days=1)
            if self.is_holiday(next_dt):
                continue
            return next_dt

    def previous_business_day(self, dt):
        next_dt = dt
        for i in range(10):
            next_dt -= timedelta(days=1)
            if self.is_holiday(next_dt):
                continue
            return next_dt

    def multi_previous_business_day(self, dt, num):
        for i in range(num):
            dt = self.previous_business_day(dt)
        return dt

    def end_of_month(self, dt: datetime) -> datetime:
        next_month = dt.replace(day=28) + timedelta(days=4)
        return next_month - timedelta(days=next_month.day)

    def end_of_month2(self, date_string='2018-12-12') -> date:
        # get_last_day_of_month
        dt = datetime.strptime(date_string, '%Y-%m-%d').date()
        return date(dt.year + dt.month // 12, dt.month % 12 + 1, 1) - timedelta(1)

    def get_last_day_of_last_month(self, dt=None, date_string: str = None) -> date:
        # get the last day in last month of as of date
        # date_string = '2018-01-23' and Adding default parameter value with type hint in Python
        if date_string:
            dt = datetime.strptime(date_string, '%Y-%m-%d').date()
        if dt.month == 12 and dt.day != 31:
            dt = date(dt.year, dt.month, 1) - timedelta(1)
        elif dt.month == 12 and dt.day == 31:
            dt = dt
        elif dt != date(dt.year, dt.month + 1, 1) - timedelta(1):
            dt = date(dt.year, dt.month, 1) - timedelta(1)
        return dt

    def is_holiday(self, dt: datetime) -> bool:
        if self.is_weekend(dt):
            return True

        return self.to_string(dt) in self.holidays

    def is_weekend(self, dt):
        return dt.isoweekday() in self.WEEKEND

    def is_leap_year(self, dt):
        year = dt.year
        return year % 4 == 0 and (year % 100 != 0 or year % 400 == 0)

    def is_first_business_day(self, dt):
        if dt.month != self.previous_business_day(dt).month:
            return True
        return False

    def is_last_business_day(self, dt):
        if dt.month != self.next_business_day(dt).month:
            return True
        return False
